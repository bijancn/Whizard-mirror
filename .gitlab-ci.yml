stages:
  - autotools
  - build
  - cleanup_build
  - test
  - deploy

autotools:
  stage: autotools
  script:
    - autoreconf
  artifacts:
    untracked: true

build:nagfor:
  stage: build
  script:
    - mkdir -p build.nagfor
    - cd build.nagfor
    - ../configure FC=nagfor FCFLAGS="-O0 -C=all -gline -nan -f2008" --prefix="`pwd`/../install.nagfor" --disable-static
    - make > make.log
    - make install > make-install.log
  cache:
    paths:
      - build.nagfor/
  artifacts:
    paths:
      - build.nagfor/

build:gfortran:
  stage: build
  script:
    - mkdir -p build.gfortran
    - cd build.gfortran
    - ../configure FC=gfortran FCFLAGS="-O0" --prefix="`pwd`/../install.gfortran" --disable-static
    - make > make.log
    - make install > make-install.log
  cache:
    paths:
      - build.gfortran/
  artifacts:
    paths:
      - build.gfortran/

build:nagfor:distribution:
  stage: build
  script:
    - mkdir -p build.nagfor.distribution
    - cd build.nagfor.distribution
    - ../configure FC=nagfor FCFLAGS="-O0 -C=all -gline -nan -f2008" --prefix="`pwd`/../install.nagfor.distribution" --enable-distribution
    - make distcheck > make.distcheck.log
    - make extra-distcheck > make.extra-distcheck.log
  only:
    - master

build:gfortran:distribution:
  stage: build
  script:
    - mkdir -p build.gfortran:distribution
    - cd build.gfortran:distribution
    - ../configure FC=gfortran FCFLAGS="-O0" --prefix="`pwd`/../install.gfortran" --enable-distribution
    - make distcheck > make.distcheck.log
    - make extra-distcheck > make.extra-distcheck.log
  only:
    - master

test:nagfor:
  stage: test
  script:
    - cd build.nagfor
    - make check > make-check.log
  cache:
    paths:
      - build.nagfor/

test:gfortran:
  stage: test
  script:
    - cd build.gfortran
    - make check > make-check.log
  cache:
    paths:
      - build.gfortran/
