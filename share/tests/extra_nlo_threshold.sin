?logging = true
?openmp_logging = false
?vis_history = false
?integration_timer = false

!!! Tests should be run single-threaded
openmp_num_threads = 1

model = SM_tt_threshold
sqrts = 345 GeV
sqrtsmin = sqrts - 5 GeV
sqrtsmax = sqrts + 5 GeV
sqrtsstepsize = 0.1 GeV

mZ = 91.188
mW = 80.419
mb = 4.2
alphas = 0.118 ! (Z pole, NLL running to mu_h)
alpha_em_i = 125.924 ! (not running)
m1S = 172.0
scale = m1S
mpole_fixed = 1
mult_call_real = 30

nrqcd_order  = 1 # NLL
sh     = 1.
sf     = 1.
Vtb    = 1.

me = 0
int n_iter = 1000

$method = "threshold"
$born_me_method = "threshold"
$loop_me_method = "threshold"
$correlation_me_method = "threshold"
$real_tree_me_method = "threshold"
alpha_power = 4
alphas_power = 0
real num_diff = 0.0001

! bits for offshell strategy :
! NLO|factorization|interference|onshellprojection|LOwidthinsignal
if (true) then
  !!! Null check: Set formfactor to 0 and use only the signal part
  process extra_nlo_threshold_null = e1, E1 => Wp, Wm, b, B
  iterations = 1:n_iter
  FF = 10
  offshell_strategy = 0+2+0+0+0 ! activate factorization
  seed = 0
  integrate (extra_nlo_threshold_null)
  expect (integral (extra_nlo_threshold_null) == 0.0)

  !!! tree level result from amp_blob, i.e. with factorized onshell LO decays
  process extra_nlo_threshold_factorized = e1, E1 => Wp, Wm, b, B
  iterations = 5:n_iter:"gw", 5:n_iter
  FF = 9
  offshell_strategy = 0+2+0+0+0 ! activate factorization
  seed = 0
  integrate (extra_nlo_threshold_factorized)

  !!! and with the nlo command
  process extra_nlo_threshold_born = e1, E1 => Wp, Wm, b, B {nlo_calculation = "Born"}
  seed = 0
  integrate (extra_nlo_threshold_born)
  !!! same numbers but different program flow
  expect (integral (extra_nlo_threshold_factorized) ==
    integral (extra_nlo_threshold_born)) {tolerance = num_diff}

  !!! Now we disable the FF (get the result directly from omega) and compare
  !!! signal to factorized
  process extra_nlo_threshold_signal = e1, E1 => Wp, Wm, b, B {$restrictions = "3+5~t && 4+6~tbar"}
  FF = 10
  offshell_strategy = 0+0+4+0+0 ! activate interference
  seed = 0
  integrate (extra_nlo_threshold_signal)
  !!! Differences of O(Gamma/M) are ok
  expect (integral (extra_nlo_threshold_signal) ==
    integral (extra_nlo_threshold_factorized)) {tolerance = 3 * wtop / mtpole * integral (extra_nlo_threshold_signal)}

  !!! We can also compute the signal diagram in the signal component (in threshold.f90)
  process extra_nlo_threshold_signal_threshold = e1, E1 => Wp, Wm, b, B
  FF = 9
  offshell_strategy = 0+0+0+0+0
  seed = 0
  integrate (extra_nlo_threshold_signal_threshold)
  expect (integral (extra_nlo_threshold_signal_threshold) ==
    integral (extra_nlo_threshold_signal)) {tolerance = num_diff}

  !!! Make sure that we get exactely the same when we use OMega natively
  process extra_nlo_threshold_native = e1, E1 => Wp, Wm, b, B {$restrictions = "3+5~t && 4+6~tbar"}
  FF = 10
  seed = 0
  $method = "omega"
  integrate (extra_nlo_threshold_native)
  expect (integral (extra_nlo_threshold_native) ==
    integral (extra_nlo_threshold_signal)) {tolerance = num_diff}

  !!! Now with onshell projection
  $method = "threshold"
  process extra_nlo_threshold_onshell = e1, E1 => Wp, Wm, b, B
  FF = 9
  offshell_strategy = 0+2+0+8+0
  seed = 0
  integrate (extra_nlo_threshold_onshell)
  !!! Differences of O(Gamma/M) are ok
  expect (integral (extra_nlo_threshold_onshell) ==
    integral (extra_nlo_threshold_signal)) {tolerance = 3 * wtop / mtpole * integral (extra_nlo_threshold_onshell)}

  printf "factorized: %g +- %g" (integral(extra_nlo_threshold_factorized),
        error(extra_nlo_threshold_factorized))
  printf "onshell: %g +- %g" (integral(extra_nlo_threshold_onshell),
        error(extra_nlo_threshold_onshell))
  printf "signal: %g +- %g" (integral(extra_nlo_threshold_signal),
        error(extra_nlo_threshold_signal))
endif

!!! On to NLO decays
!iterations = 5:n_iter:"gw", 5:n_iter
!FF = 9                   ! FF = 1
!offshell_strategy = -4

!process extra_nlo_threshold_p5 = e1, E1 => Wp, Wm, b, B {nlo_calculation = "Full"}
!integrate (extra_nlo_threshold_p5)

!model = SM
!mZ = 91.188
!mW = 80.419
!mb = 4.2
!alphas = 0.118 ! (Z pole, NLL running to mu_h)
!GF = 1.2273E-005
!mtop = 172.0
!wtop = 1.5385601
!scale = mtop
!$method = "omega"
!seed = 0
!process extra_nlo_threshold_p6 = e1, E1 => Wp, Wm, b, B {$restrictions = "3+5~t && 4+6~tbar"}
!integrate (extra_nlo_threshold_p6)

! Differences at permille-level come from the precision of the input parameters
!expect (integral (extra_nlo_threshold_p1) ==
  !integral (extra_nlo_threshold_p6)) {tolerance = 0.001 * integral (extra_nlo_threshold_p1)}
